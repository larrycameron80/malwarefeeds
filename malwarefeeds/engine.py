# -*- coding: utf-8 -*-
"""An Engine to handle the malware feeds."""

import malwarefeeds.feeds as feeds
import malwarefeeds.parsers as parsers


class Engine(object):
    """An Engine to handle the malware feeds."""

    def __init__(self):
        """Initialize the Engine object."""
        self.malcode = None
        self.mdl = None
        self.vxvault = None
        self.malwareurls = None
        self.ransomware = None

    def update(self):
        """Fetch the content from all feeds."""
        self.malcode = feeds.get_malcode()
        self.mdl = feeds.get_mdl()
        self.vxvault = feeds.get_vxvault()
        self.malwareurls = feeds.get_malwareurls()
        self.ransomware = feeds.get_ransomware()

    def read(self, fn_callback=None):
        """
        Read and parse all feeds.

        :param fn_callback: A callback function to retrieve feed name and URL
        """
        if fn_callback is None:
            return

        if self.malcode is not None:
            for url in parsers.parse_xml_list_desc(self.malcode):
                fn_callback(u'Malc0de', url)

        if self.mdl is not None:
            for url in parsers.parse_xml_list_desc(self.mdl):
                fn_callback(u'Malware Domain List', url)

        if self.vxvault is not None:
            for url in parsers.parse_txt_file(self.vxvault):
                fn_callback(u'VxVault', url)

        if self.malwareurls is not None:
            for url in parsers.parse_txt_file(self.malwareurls, b'\n'):
                fn_callback(u'Malware URLs', url)

        if self.ransomware is not None:
            for url in parsers.parse_txt_file(self.ransomware, b'\n'):
                fn_callback(u'Ransomware Tracker', url)
